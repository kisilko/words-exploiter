package pl.codearea.wordsexploiter.controllers.rest;

import opennlp.tools.tokenize.TokenizerModel;
import org.apache.pdfbox.pdmodel.PDDocument;
import org.apache.pdfbox.text.PDFTextStripper;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.Arrays;
import java.util.Map;
import java.util.TreeMap;
import java.util.regex.Pattern;
import java.util.stream.Stream;

/**
 * Created by kisilko on 01.07.17.
 */
@RestController
@RequestMapping("/api")
public class ContentController {

    @PostMapping("/new-content")
    public Map<String, Integer> handleFileUpload(@RequestParam("file") MultipartFile file) throws IOException{
        System.out.println("file upload");

        Map<String, Integer> response = new TreeMap<>();

        PDDocument document = PDDocument.load(file.getInputStream());

        PDFTextStripper textStripper = new PDFTextStripper();


        Path tokenBinPath = Paths.get("src/main/nlpmodels/en-token.bin").toAbsolutePath();
        TokenizerModel tokenModel = new TokenizerModel(tokenBinPath);



        for(int pageNumber = 0; pageNumber < document.getNumberOfPages(); ++pageNumber) {
            textStripper.setStartPage(pageNumber);
            textStripper.setEndPage(pageNumber);
            String[] splited = textStripper.getText(document).toLowerCase().split("\\s+");

            Stream<String> wordsStream = Arrays.stream(splited);
            wordsStream
                    .filter(word -> Pattern.matches("^['a-z]{2,}$", word))
                    .forEach(word -> {
                response.computeIfAbsent(word, k -> 1);
                response.computeIfPresent(word, (k, v) -> v + 1);
            });

        }

        document.close();
        return response;

//        PdfReader pdfReader = new PdfReader(file.getInputStream());
//        PdfDocument pdfDocument = new PdfDocument(pdfReader);
//        String text = PdfTextExtractor.getTextFromPage(pdfDocument.getPage(50));
//        System.out.println(text);
//        System.out.println(pdfDocument.getNumberOfPages());
    }
}
