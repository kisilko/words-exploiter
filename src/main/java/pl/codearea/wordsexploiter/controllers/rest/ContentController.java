package pl.codearea.wordsexploiter.controllers.rest;

import org.apache.pdfbox.pdmodel.PDDocument;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;
import pl.codearea.wordsexploiter.model.Content;
import pl.codearea.wordsexploiter.model.FileStorageService;
import pl.codearea.wordsexploiter.model.entity.Book;
import pl.codearea.wordsexploiter.repository.BookSummary;

import java.io.IOException;
import java.util.List;

/**
 * Created by kisilko on 01.07.17.
 */
@RestController
@RequestMapping("/api/content")
public class ContentController {

    @Autowired
    private Content content;

    @Autowired
    private FileStorageService fileStorageService;

    @GetMapping("/{id}")
    public Book get(@PathVariable Integer id) {
        return content.findById(id);
    }

    @GetMapping("/text/{id}")
    public String getText(@PathVariable Integer id) {
        return fileStorageService.load(id);
    }

    @GetMapping("/list")
    public List<BookSummary> list() {
        return content.getAll();
    }

    @PostMapping("/new")
    public String handleFileUpload(@RequestParam("file") MultipartFile file) throws IOException {
        System.out.println("file upload");
        PDDocument document = PDDocument.load(file.getInputStream());
        int id = content.addPDDocument(document);
        fileStorageService.store(file, id);
//
//        Path tokenBinPath = Paths.get("src/main/nlpmodels/en-token.bin").toAbsolutePath();
//        TokenizerModel tokenModel = new TokenizerModel(tokenBinPath);

        return null;

//        PdfReader pdfReader = new PdfReader(file.getInputStream());
//        PdfDocument pdfDocument = new PdfDocument(pdfReader);
//        String text = PdfTextExtractor.getTextFromPage(pdfDocument.getPage(50));
//        System.out.println(text);
//        System.out.println(pdfDocument.getNumberOfPages());
    }

    @PostMapping("/delete/{id}")
    public void delete(@PathVariable("id") Integer id) {
        content.delete(id);
    }
}
