package pl.codearea.wordsexploiter.model;

import com.sun.xml.internal.ws.policy.privateutil.PolicyUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import pl.codearea.wordsexploiter.model.entity.WordList;
import pl.codearea.wordsexploiter.repository.WordListRepository;
import pl.codearea.wordsexploiter.utils.JacksonUtil;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;
import java.util.regex.Pattern;
import java.util.stream.Collectors;

@Service
public class TrainingService {

    @Autowired
    private WordListRepository wordListRepository;

    private static final String FREQUENCY_LISTS_PATH = "src/main/resources/frequency-lists/";
    private static final Pattern CSV_SPLIT_BY = Pattern.compile(",");

    public List<WordList> getImportedWordLists() {
        return wordListRepository.findAll();
    }

    public List<String> getWordLists() {
        try {
            return Files.list(Paths.get(FREQUENCY_LISTS_PATH))
                .filter(Files::isRegularFile)
                .map(Path::getFileName)
                .map(Path::toString)
                .sorted()
                .collect(Collectors.toList());
        } catch (IOException e) {
            e.printStackTrace();
            return Collections.emptyList();
        }
    }

    public void importList(String name) {
        Path listToImport = Paths.get(FREQUENCY_LISTS_PATH + name);
        try {
            List<String> words = Files.readAllLines(listToImport).stream()
                .flatMap(CSV_SPLIT_BY::splitAsStream)
                .collect(Collectors.toList());

            WordList wordList = new WordList();
            wordList.setName(name);
            wordList.setWords(JacksonUtil.toString(words));
            wordListRepository.save(wordList);

        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    public WordList getImportedWordList(String name) {
        WordList wordList = wordListRepository.findByName(name + ".csv");
        return wordList;
    }
}
