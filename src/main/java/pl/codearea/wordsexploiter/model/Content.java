package pl.codearea.wordsexploiter.model;

import org.apache.pdfbox.pdmodel.PDDocument;
import org.apache.pdfbox.text.PDFTextStripper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import pl.codearea.wordsexploiter.model.entity.Book;
import pl.codearea.wordsexploiter.model.entity.ContentUnit;
import pl.codearea.wordsexploiter.model.entity.Page;
import pl.codearea.wordsexploiter.repository.BookRepository;

import java.io.IOException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.TreeMap;
import java.util.regex.Pattern;
import java.util.stream.Collectors;

@Service
public class Content {

    private static final Pattern CONJUNCTION_PATTERN = Pattern.compile("^['a-z]{2,}$");

    @Autowired
    private BookRepository bookRepository;

    public void addPDDocument(PDDocument document) throws IOException {
        PDFTextStripper textStripper = new PDFTextStripper();

        final Map<String, Integer> uniqueContent = getPDDocumentUniqueContent(document);

        Book book = new Book();
        book.setTitle(document.getDocumentInformation().getTitle());
        book.setUniqueContent(
            uniqueContent.entrySet().stream()
                .map(entry -> {
                    ContentUnit contentUnit = new ContentUnit();
                    contentUnit.setWord(entry.getKey());
                    contentUnit.setFrequency(entry.getValue());
                    return contentUnit;
                }).collect(Collectors.toList())
        );
        bookRepository.save(book);

        List <String> bookContent = new ArrayList<>(uniqueContent.keySet());
        List<Page> pages = new ArrayList<>();
        for(int pageNumber = 0; pageNumber < document.getNumberOfPages(); ++pageNumber) {
            textStripper.setStartPage(pageNumber);
            textStripper.setEndPage(pageNumber);
            String[] splited = textStripper.getText(document).toLowerCase().split("\\s+");

            Page page = new Page();
            page.setNumber(pageNumber);

            Set<Integer> uniquePageContent = Arrays.stream(splited)
                    .filter(word -> CONJUNCTION_PATTERN.matcher(word).matches())
                    .map(word -> bookContent.indexOf(word) + 1)
                    .collect(Collectors.toSet());
            page.setUniqueContent(uniquePageContent);
            pages.add(page);
        }
        book.setPages(pages);
        bookRepository.save(book);
    }

    private Map<String, Integer> getPDDocumentUniqueContent(PDDocument document) throws IOException {
        PDFTextStripper textStripper = new PDFTextStripper();
        int numberOfPages = document.getNumberOfPages();
        textStripper.setStartPage(0);
        textStripper.setEndPage(numberOfPages);
        String[] splited = textStripper.getText(document).toLowerCase().split("\\s+");

        return Arrays.stream(splited)
            .filter(word -> CONJUNCTION_PATTERN.matcher(word).matches())
            .collect(Collectors.toMap(
                word -> word, word -> 1, (n1, n2) -> n1 + 1, TreeMap::new
            ));
    }
}
