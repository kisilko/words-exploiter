package pl.codearea.wordsexploiter.model;

import org.openqa.selenium.By;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.chrome.ChromeDriver;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import pl.codearea.wordsexploiter.model.entity.Translation;
import pl.codearea.wordsexploiter.repository.TranslationRepository;
import pl.codearea.wordsexploiter.utils.Chromium;

import java.util.List;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import java.util.stream.Collectors;

@Service
public class TranslationService {

    @Autowired
    private Chromium chromium;

    @Autowired
    TranslationRepository translationRepository;

    private ChromeDriver driver;

    private Pattern audioFileIdPattern = Pattern.compile("\\(\\D+(\\d+)\\D+\\)");

    private final static String DICTIONARY_URL = "https://en.bab.la/dictionary/english-polish/";

    public synchronized Translation getWordTranslation(String word) {
        Translation translation = translationRepository.findByWord(word);
        if (translation == null) {
            translation = fetchTranslation(word);
            translationRepository.save(translation);
        }
        return translation;
    }

    private Translation fetchTranslation(String word) {
        ChromeDriver driver = getDriver();
        driver.get(DICTIONARY_URL + word);

        Translation translation = new Translation();
        translation.setWord(word);
        translation.setAudioFileId(getAudioFileId(driver));
        translation.setTranslations(getTranslations(driver));

        return translation;
    }

    private List<String> getTranslations(ChromeDriver driver) {
        List<WebElement> translations = driver.findElements(By.cssSelector("#translationsdetails1 .dict-entry .dict-result strong"));
        return translations.stream()
                .map(WebElement::getText)
                .collect(Collectors.toList());
    }

    private Integer getAudioFileId(ChromeDriver driver) {
        //#translationsdetails1 .result-block-header a
        String audioScript = driver.findElement(By.cssSelector("#translationsdetails1 .result-block-header a")).getAttribute("href");
        Matcher matcher = audioFileIdPattern.matcher(audioScript);
        String audioFileId = matcher.find() ? matcher.group(1) : "";
        try {
            return Integer.parseInt(audioFileId);
        } catch (Exception e) {
            e.printStackTrace();
        }
        return 0;
    }

    private ChromeDriver getDriver() {
        if (driver == null) {
            driver = chromium.newDriver();
        }
        return driver;
    }
}

