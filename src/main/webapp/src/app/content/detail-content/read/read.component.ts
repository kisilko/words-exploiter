import { Component, OnInit, OnDestroy } from '@angular/core';
import { ContentService } from 'app/content/content.service';
import * as PDFJS from 'pdfjs-dist/webpack.js';
import { PDFPageProxy } from 'pdfjs-dist';
import { ActivatedRoute } from '@angular/router';
import { Book } from 'app/content/content.interface';

@Component({
  selector: 'app-read',
  templateUrl: './read.component.html',
  styleUrls: ['./read.component.sass']
})
export class ReadComponent implements OnInit, OnDestroy {

  bookId: number;
  book: Book;
  pdfDoc;
  pageNum: number;
  pdfPage: PDFPageProxy;

  currentPageNumber = 1;
  displayPages = 10;
  paginationRange: Array<number>;
  routeSubscribbtion;

  constructor(private contentService: ContentService, private route: ActivatedRoute) { }

  ngOnInit() {
    this.bookId = +this.route.parent.snapshot.paramMap.get('id');
    this.pdfDoc = PDFJS.getDocument('/books/' + this.bookId + '.pdf');
    this.contentService.getContent(this.bookId).subscribe(book => {
      this.book = book;
      this.setPaginationRange();
      this.loadPage();
      this.routeSubscribe();
    });
  }

  loadPage() {
    this.pdfDoc
      .then(pdf => pdf.getPage(this.currentPageNumber))
      .then(page => {
        this.pdfPage = page;
      });
  }

  routeSubscribe() {
    this.routeSubscribbtion = this.route.paramMap.subscribe(params => {
      if (params.has('pageId')) {
        this.currentPageNumber = +params.get('pageId');
      } else {
        this.currentPageNumber = 1;
      }
      this.setPaginationRange();
      this.loadPage();
    });
  }

  setPaginationRange() {
    const pageCount = this.book.pages.length;
    this.paginationRange = new Array();
    for (let i = this.currentPageNumber - this.displayPages / 2; i < this.currentPageNumber + this.displayPages / 2; i++) {
      this.paginationRange.push(i);
    }
    this.paginationRange = this.paginationRange.map((val, i) => {
      if (val < 1) {
        return this.currentPageNumber + (this.displayPages / 2) + i;
      }
      if (val > pageCount) {
        return this.currentPageNumber - (this.displayPages / 2) - this.displayPages + i;
      }
      return val;
    });
    this.paginationRange.sort((a, b) => a - b);
  }

  ngOnDestroy() {
    this.routeSubscribbtion.unsubscribe();
  }
}
