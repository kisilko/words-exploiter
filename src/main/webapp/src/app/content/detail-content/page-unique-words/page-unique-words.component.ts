import { Component, OnInit, OnDestroy } from '@angular/core';
import { ContentService } from 'app/content/content.service';
import { ActivatedRoute } from '@angular/router';
import { Book, Page } from 'app/content/content.interface';
import * as lodash from 'lodash';
import { Subscription } from 'rxjs';

@Component({
  selector: 'app-page-unique-words',
  templateUrl: './page-unique-words.component.html',
  styleUrls: ['./page-unique-words.component.scss']
})
export class PageUniqueWordsComponent implements OnInit, OnDestroy {

  dataLoaded: boolean = false;
  book: Book;
  currentPage: Page;
  currentPageNumber = 1;
  displayPages = 10;
  paginationRange: Array<number>;
  routeSubscribbtion: Subscription;
  knownWordsServiceSubscription: Subscription;

  constructor(private route: ActivatedRoute, 
    private contentService: ContentService) { }

  ngOnInit() {
    const bookId = +this.route.parent.snapshot.paramMap.get('id');

    this.contentService.getContent(bookId).subscribe(book => {
      this.book = book;
      this.setPaginationRange();
      this.routeSubscribe();
      this.dataLoaded = true;
    });
  }

  routeSubscribe() {
    this.routeSubscribbtion = this.route.paramMap.subscribe(params => {
      if (params.has('pageId')) {
        this.currentPageNumber = +params.get('pageId');
        this.setPaginationRange();
        this.currentPage = this.book.pages[this.currentPageNumber - 1];
        this.currentPage.uniqueContent.sort();
      }
    });
  }

  setPaginationRange() {
    const pageCount = this.book.pages.length;
    this.paginationRange = new Array();
    for (let i = this.currentPageNumber - this.displayPages / 2; i < this.currentPageNumber + this.displayPages / 2; i++) {
      this.paginationRange.push(i);
    }
    this.paginationRange = this.paginationRange.map((val, i) => {
      if (val < 1) {
        return this.currentPageNumber + (this.displayPages / 2) + i;
      }
      if (val > pageCount) {
        return this.currentPageNumber - (this.displayPages / 2) - this.displayPages + i;
      }
      return val;
    });
    this.paginationRange.sort((a, b) => a - b);
  }

  ngOnDestroy() {
    this.routeSubscribbtion.unsubscribe();
  }
}
