import { Component, OnInit, OnDestroy } from '@angular/core';
import { KnownWordsService } from 'app/content/known-words.service';
import { ContentService } from 'app/content/content.service';
import { ActivatedRoute } from '@angular/router';
import { WordStatus, ContentUnit, Book, KnownWord, Page } from 'app/content/content.interface';
import * as lodash from 'lodash';
import { forkJoin } from 'rxjs';
import { map } from 'rxjs/operators';

@Component({
  selector: 'app-page-unique-words',
  templateUrl: './page-unique-words.component.html',
  styleUrls: ['./page-unique-words.component.scss']
})
export class PageUniqueWordsComponent implements OnInit, OnDestroy {

  dataLoaded: boolean = false;
  book: Book;
  knownWords: Map<String, WordStatus> = new Map();

  currentPage: Page;
  currentPageNumber = 1;
  displayPages = 10;
  paginationRange: Array<number>;
  routeSubscribbtion;

  constructor(private route: ActivatedRoute, 
    private knownWordsService: KnownWordsService, 
    private contentService: ContentService) { }

  ngOnInit() {
    const bookId = +this.route.parent.snapshot.paramMap.get('id');

    forkJoin(
      this.contentService.getContent(bookId),
      this.knownWordsService.getAll()
    ).pipe(map(([book, knownWords]) => {
      this.book = book;
      this.setPaginationRange();
      this.routeSubscribe();
      knownWords.forEach(kw => this.knownWords.set(kw.word, kw.status));
      this.dataLoaded = true;
    })).subscribe();
  }

  routeSubscribe() {
    this.routeSubscribbtion = this.route.paramMap.subscribe(params => {
      if (params.has('pageId')) {
        this.currentPageNumber = +params.get('pageId');
        this.setPaginationRange();
        this.currentPage = this.book.pages[this.currentPageNumber - 1];
        this.currentPage.uniqueContent.sort();
      }
    });
  }

  setPaginationRange() {
    const pageCount = this.book.pages.length;
    this.paginationRange = new Array();
    for (let i = this.currentPageNumber - this.displayPages / 2; i < this.currentPageNumber + this.displayPages / 2; i++) {
      this.paginationRange.push(i);
    }
    this.paginationRange = this.paginationRange.map((val, i) => {
      if (val < 1) {
        return this.currentPageNumber + (this.displayPages / 2) + i;
      }
      if (val > pageCount) {
        return this.currentPageNumber - (this.displayPages / 2) - this.displayPages + i;
      }
      return val;
    });
    this.paginationRange.sort((a, b) => a - b);
  }

  updateWordStatus(knownWord: KnownWord) {
    this.knownWords.set(knownWord.word, knownWord.status);
    this.knownWordsService.add(knownWord);
  }

  getWordStatus(word: String) {
    if (this.knownWords.has(word)) {
      return this.knownWords.get(word);
    }
    return WordStatus.Unknown;
  }

  ngOnDestroy() {
    this.routeSubscribbtion.unsubscribe();
  }
}
