import { Component, OnInit, OnDestroy } from '@angular/core';
import { TimerObservable } from "rxjs/observable/TimerObservable";
import { ContentService } from '../content.service';
import { BookSummary } from '../content.interface';
import * as lodash from 'lodash';

@Component({
  selector: 'app-list-content',
  templateUrl: './list-content.component.html',
  styleUrls: ['./list-content.component.sass']
})
export class ListContentComponent implements OnInit, OnDestroy {

  contentList: Array<BookSummary>;
  bookProcessing = true;

  constructor(private contentService: ContentService) { }

  ngOnInit() {
    TimerObservable.create(0, 3000)
      .takeWhile(() => this.bookProcessing)
      .subscribe(() => {
        this.contentService.getAll().subscribe((res: Array<BookSummary>) => {
          this.contentList = res;

          if (!this.isOngoingBookProcessing(res)) {
            this.bookProcessing = false;
          }
        });
      });
  }

  delete(id: number) {
    if(confirm('Are you sure you want to delete "' + this.contentList.find(el => el.id == id).title + '"')) {
      const i = lodash.findIndex(this.contentList, bs => bs.id === id);
      this.contentList.splice(i, 1);
      this.contentService.delete(id);
    }
  }

  isOngoingBookProcessing(booksSummary: Array<BookSummary>) {
    return booksSummary.find(bookSummary => bookSummary.parsingCompleted === false);
  }

  ngOnDestroy(){
    this.bookProcessing = false;
  }
}
