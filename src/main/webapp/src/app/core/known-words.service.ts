import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { KnownWord, WordStatus } from '../content/content.interface';
import { Subject, ReplaySubject } from 'rxjs';
import { map } from 'rxjs/operators';

@Injectable()
export class KnownWordsService {

  private allDataSource = new ReplaySubject<Map<string, WordStatus>>(1);
  private knownWordsSource = new Subject<KnownWord>();

  knownWords$ = this.knownWordsSource.asObservable();
  allData$ = this.allDataSource.asObservable();

  refresh = true;

  constructor(private http: HttpClient) {}

  update(knownWord: KnownWord) {
    this.http.post('/api/known-words/add', knownWord).subscribe(response => {
        this.knownWordsSource.next(knownWord);
        this.refresh = true;
      }
    );
  }

  getAll() {
    if (this.refresh) {
      this.refresh = false;
      
      this.http.get<Array<KnownWord>>('/api/known-words/list').pipe(
        map(knownWords => {
          const wordMap = new Map();
          knownWords.forEach(kw => {
            wordMap.set(kw.word, kw.status);
          })
          return wordMap;
        })
      ).subscribe(res => {
        this.allDataSource.next(res);
      });
    }
    return this.allData$;
  }
}
