import { Component, OnInit } from '@angular/core';
import { ActivatedRoute } from '@angular/router';
import { WordListsService } from '../word-lists/word-lists.service';
import { map, mergeMap } from 'rxjs/operators';
import * as lodash from 'lodash';
import { TranslationService } from 'app/shared/translation.service';

@Component({
  selector: 'app-practice',
  templateUrl: './practice.component.html',
  styleUrls: ['./practice.component.scss']
})
export class PracticeComponent implements OnInit {

  static readonly WORDS_PER_PAGE = 10;
  index = 0;
  offset = PracticeComponent.WORDS_PER_PAGE;
  lists: Array<string>;
  wordsToPractice: Array<string> = new Array();
  wordsToPracticePage: Array<{ word: string, translation: string }>;
  showWords = false;

  constructor(private route: ActivatedRoute,
    private translationService: TranslationService,
    private wordListsService: WordListsService) { }

  ngOnInit() {
    this.lists = this.route.snapshot.paramMap.get('lists').split(';');
    this.wordListsService.getImportedWordListByNames(this.lists)
      .subscribe(importedWordLists => {
        importedWordLists.forEach(list => {
          if (list.wordsToPractice) {
            this.wordsToPractice = this.wordsToPractice.concat(Array.from(list.wordsToPractice));
          }
        });
        lodash.shuffle(this.wordsToPractice);
        this.getWordsToPractice();
      });
  }

  getWordsToPractice() {
    this.showWords = false;
    const words = this.wordsToPractice.slice(this.index, this.offset);
    this.index += this.offset;
    this.offset += this.offset;

    this.wordsToPracticePage = new Array();
    words.forEach(word => {
      this.translationService.getTranslation(word).subscribe(resp => {
        const translation = resp.translations.slice(0, 4).join(', ');
        this.wordsToPracticePage.push({ word: word, translation: translation });
      });
    });
  }

  onCheck() {
    this.showWords = true;
  }

  onTryAgain() {
    this.index = 0;
    this.offset = PracticeComponent.WORDS_PER_PAGE;
    this.wordsToPractice.sort(() => 0.5 - Math.random());
    //lodash.shuffle(this.wordsToPractice);
    this.getWordsToPractice();
  }

}
