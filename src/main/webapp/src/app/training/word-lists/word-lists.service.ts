import { Injectable } from '@angular/core';
import { HttpClient, HttpHeaders } from '@angular/common/http';
import { WordList } from '../training.interface';
import { map } from 'rxjs/operators';

@Injectable({
  providedIn: 'root'
})
export class WordListsService {

  constructor(private http: HttpClient) {}

  getWordLists() {
    return this.http.get<Array<string>>('/api/training/get-word-lists');
  }

  getImportedWordListByNames(names: Array<string>) {
    return this.http.get<Array<WordList>>('/api/training/get-imported-word-lists/' + encodeURIComponent(names.map(name => name.replace('.csv', '')).join(';'))).pipe(
      map(response => this.parseJsonsImportedWordLists(response))
    );
  }

  getImportedWordList(name: string) {
    return this.http.get<WordList>('/api/training/get-imported-word-list/' + name ).pipe(
      map(response => this.parseJsonsImportedWordList(response))
    );
  }

  getImportedWordLists() {
    return this.http.get<Array<WordList>>('/api/training/get-imported-word-lists');
  }

  import(listName: string) {
    return this.http.post('/api/training/import-list/', listName).subscribe();
  }

  updatePractice(practiceList: any) {
    return this.http.post('/api/training/update-practice', practiceList).subscribe();
  }

  private parseJsonsImportedWordLists(importedWordLists: Array<WordList>) {
    importedWordLists.forEach(importedWordList => {
      importedWordList = this.parseJsonsImportedWordList(importedWordList);
    });
    return importedWordLists;
  }

  private parseJsonsImportedWordList(importedWordList: WordList) {
    if (typeof importedWordList.words === 'string') {
      importedWordList.words = JSON.parse(importedWordList.words);
    } 
    if (typeof importedWordList.wordsToPractice === 'string') {
      importedWordList.wordsToPractice = new Set(JSON.parse(importedWordList.wordsToPractice));
    }
    if (!importedWordList.wordsToPractice) {
      importedWordList.wordsToPractice = new Set();
    }
    return importedWordList;
  }
}
